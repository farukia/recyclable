<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recycle Disciple</title>
  <link href="style.css" rel="stylesheet" />
  <style>
    .title {
      text-align: center;
      font-family: 'Montserrat', sans-serif;
      font-size: 24px;
      margin-top: 20px;
    }
    .center-button {
      text-align: center;
      margin-top: 10px;
    }
    #text {
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="title">The Recycle Disciple</div>
  <div class="loader" id="loader"></div> 

  <div class="center-button">
    <button onclick="init()">Start</button>
  </div>

  <div class="center-button">
    <button id="toggleButton" onclick="toggleCamera()" style="display: none;">Toggle Camera</button>
  </div>

  <div id="webcam-container" style="text-align:center;"></div>
  <div id="label-container" style="text-align:center;"></div>
  <p id="text" style="text-align:center;"></p>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest"></script>

  <script>
    const URL = "https://teachablemachine.withgoogle.com/models/Q0vMyAAez/";
    const feedback = [
      "PET 1 - Can be recycled at curbside or your local recycling center",
      "HDPE 2 - Can be recycled at curbside or your local recycling center. Lids may be replaced.",
      "PVC 3 - These are generally not recyclable.",
      "LDPE 4 - These are generally not recyclable.",
      "PP 5 - These are generally recyclable.",
      "PS 6 - These are generally not recyclable.",
      "Other 7 - These are generally not recyclable."
    ];
  
    let model, maxPredictions;
    let stream;
    let facingMode = "environment"; // start with back camera
  
    async function init() {
      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";
      document.getElementById("loader").style.display = "block";
      document.getElementById("text").innerText = "Loading...";
  
      model = await tmImage.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();
  
      await startCamera();
      document.getElementById("toggleButton").style.display = "inline-block";
      document.getElementById("loader").style.display = "none";
    }
  
    async function startCamera() {
      const constraints = {
        video: {
          facingMode: { ideal: facingMode }
        },
        audio: false
      };
  
      try {
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
  
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        const video = document.createElement("video");
        video.setAttribute("autoplay", true);
        video.setAttribute("playsinline", true);
        video.width = 200;
        video.height = 200;
  
        const webcamContainer = document.getElementById("webcam-container");
        webcamContainer.innerHTML = '';
        webcamContainer.appendChild(video);
        video.srcObject = stream;
  
        video.onloadedmetadata = () => {
          video.play();
          loop(video);
        };
      } catch (err) {
        console.error("Camera error:", err);
        alert("Failed to access the camera. Make sure you allowed permissions and are using HTTPS.");
      }
    }
  
    async function loop(video) {
      await predict(video);
      requestAnimationFrame(() => loop(video));
    }
  
    async function predict(video) {
      const prediction = await model.predict(video);
      const probabilities = prediction.map(p => parseFloat(p.probability.toFixed(2)));
      const maxIndex = probabilities.indexOf(Math.max(...probabilities));
  
      if (feedback[maxIndex]) {
        document.getElementById("text").innerText = feedback[maxIndex];
      }
    }
  
    async function toggleCamera() {
      facingMode = (facingMode === "user") ? "environment" : "user";
      await startCamera();
    }
  </script>
  
</body>
</html>
